<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Luftdaten-Heatmap</title>
    <link rel="stylesheet" href="leaflet.css" />
    <script src="leaflet.js"></script>
    <script src="leaflet-heat.js"></script>
    <style>
     #map { margin: 0; padding: 0; width: 100vw; height: 100vh; }
     body { margin: 0; padding: 0; font-family: sans-serif; }
     .legend {
         border: 1px solid #333;
         border-radius: 5px;
         background-color: white;
         color: #333;
         padding: 0.4em 1em;
         line-height: 1.4em;
     }
     .legend .colorbar {
         display: inline-block;
         vertical-align: bottom;
         height: 1em;
         line-height: 1em;
         border: 1px solid #111;
         width: 30vh;
         padding: 0;
         margin: 0 0.2em;
         background: linear-gradient(to right,
             hsla(270, 100%, 50%, 1) 0%,
             hsla(180, 100%, 50%, 1) 33%,
             hsla(90, 100%, 50%, 1) 67%,
             hsla(0, 100%, 50%, 1) 100%
         );
     }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
</head>
<body>

    <div id="map"></div>
    <script>

     var map = L.map('map').setView([50, 12], 7);

     var tiles = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
         attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors',
     }).addTo(map);

     var renderQueue = [];
     var renderPending = false;
     function render(f) {
         renderQueue.push(f);
         if (!renderPending) {
             renderPending = true;
             doRender();
         }
     }
     function doRender() {
         requestAnimationFrame(function() {
             var f = renderQueue.shift();
             if (f) {
                 f();
                 doRender();
             } else {
                 renderPending = false;
             }
         });
     }

     function renderData(data) {
         var temperatures = data.map(function(value) {
             return Number(value.temperature);
         }).sort(function(a, b) {
             return a - b;
         });

         // 10% percentile
         var minTemperature = temperatures[Math.floor(.10 * temperatures.length)];
         // 90% percentile
         var maxTemperature = temperatures[Math.floor(.90 * temperatures.length)];
         console.log('Temperature: ' + minTemperature + '..' + maxTemperature);
         
         var RECT_SIZE = 16;
         var RECT_CENTER = Math.floor(RECT_SIZE / 2);
         var MAX_DISTANCE = 50000;  /* 50 km */
         var CanvasLayer = L.GridLayer.extend({
             createTile: function(coords, done) {
                 var size = this.getTileSize();

                 // create a <canvas> element for drawing
                 var tile = L.DomUtil.create('canvas', 'leaflet-tile');
                 tile.width = size.x;
                 tile.height = size.y;
                 render(function() {
                     // draw something asynchronously and pass the tile to the done() callback
                     var ctx = tile.getContext('2d');
                     for(var y = 0; y < tile.height; y += RECT_SIZE) {
                         for(var x = 0; x < tile.width; x += RECT_SIZE) {
                             var location = map.unproject({
                                 x: coords.x * size.x + x + RECT_CENTER,
                                 y: coords.y * size.y + y + RECT_CENTER
                             }, coords.z);

                             var nearestMinDist = null;
                             var temperature = 0;
                             var totalWeight = 0;
                             for(var i = 0; i < data.length; i++) {
                                 var value = data[i];
                                 var distance = location.distanceTo(value.location);
                                 if (distance >= MAX_DISTANCE) {
                                     continue;
                                 }
                                 if (nearestMinDist === null ||
                                     distance < nearestMinDist) {

                                     nearestMinDist = distance;
                                 }
                                 var weight = MAX_DISTANCE / Math.pow(distance, 10);
                                 temperature += weight * value.temperature;
                                 totalWeight += weight;
                             }
                             temperature /= totalWeight;

                             if (nearestMinDist !== null) {
                                 var phase = Math.max(0, Math.min(270,
                                                                  270 * (1 - (temperature - minTemperature) / (maxTemperature - minTemperature))));
                                 var alpha = 0.7 * (1 - nearestMinDist / MAX_DISTANCE);

                                 ctx.fillStyle = 'hsla(' + Math.floor(phase) + ', 100%, 50%, ' + alpha + ')';
                                 ctx.fillRect(x, y, RECT_SIZE, RECT_SIZE);
                             }
                         }
                     }

                     done(null, tile);
                 });

                 return tile;
             }
         });

         new CanvasLayer().addTo(map);

         var Legend = L.Control.extend({
             onAdd: function() {
                 var container = L.DomUtil.create('div', 'legend');
                 var span = L.DomUtil.create('span', '', container);
                 span.textContent = Math.ceil(minTemperature) + '°C';
                 var span = L.DomUtil.create('span', 'colorbar', container);
                 span.textContent = ' ';
                 var span = L.DomUtil.create('span', '', container);
                 span.textContent = Math.ceil(maxTemperature) + '°C';
                 return container;
             }
         });
         map.addControl(new Legend({ position: 'bottomleft' }));
     }
     var VALUE_TYPE = 'temperature';
     /* var VALUE_TYPE = 'P1';*/
     fetch('https://api.luftdaten.info/static/v1/data.json')
         .then(function(res) {
             return res.json();
         }).then(function(json) {
             return json.map(function(sensor) {
                 var temperatureValue = sensor.sensordatavalues.filter(function(value) {
                     return value.value_type === VALUE_TYPE;
                 })[0];
                 if (temperatureValue) {
                     return {
                         temperature: Number(temperatureValue.value),
                         location: L.latLng(Number(sensor.location.latitude), Number(sensor.location.longitude))
                     };
                 } else {
                     return null;
                 }
             }).filter(function(value) {
                 return !! value;
             });
         }).then(function(data) {
             return renderData(data)
         });

    </script>
</body>
</html>
